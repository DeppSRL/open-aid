{% extends 'base_map.html' %}
{% load crs %}
{% load i18n %}
{% load icons %}
{% load staticfiles %}
{% load humanize %}

{% block page_title %}OpenAID - {{ object.title|truncatechars:10 }} - {{ object.recipient.name }}{% endblock %}
{% block og_title %}OpenAID - {{ object.title }}{% endblock %}


{% block content %}

  <div class="row">
    <header class="col-md-9">
      <h2 class="pull-left" id="initiative-{{ initiative.pk }}">{{ initiative.title }}</h2>
      <h3 class="sub-title">
        {% for recipient in initiative.recipients %}
          <a href="{% url 'codelists:recipient-detail' code=recipient.code %}">{{ recipient.name }}</a>
          {% if not forloop.last %}&middot;{% endif %}
        {% endfor %}
      </h3>
    </header>
  </div>

  <div class="spacer"> </div>

  <div class="row">
    <div class="col-md-4 col-sm-6 col-xs-6">
      <div class="small-map"><div id="map" data-chart="map" style="height: 260px;" data-iso-code="{% for recipient in initiative.recipients|unique %}{{ recipient.iso_code }}{% if not forloop.last %},{% endif %}{% endfor %}"></div></div>
      <br/>
      {% with locations=initiative.locations %}{% if locations|length > 0 %}
      <p><strong>{% trans 'Location' %}:</strong>
      {% for loc in locations|unique %}{{ loc }} {% if not forloop.last %}, {% endif %}{% endfor %}
      </p>
      {% endif %}{% endwith %}

      <h4>{% trans 'Initiative data' %}</h4>
      <dl class="dl-horizontal">
        <dt>{% trans 'CRSID' %}</dt><dd>{{ initiative.crsid }}</dd>
      </dl><dl class="dl-horizontal">
        <dt>{% trans 'Purpose' %}</dt><dd>{{ initiative.purpose.name }}</dd>
      </dl><dl class="dl-horizontal">
        <dt>{% trans 'Finance type' %}</dt><dd>{{ initiative.finance_type.name }}</dd>
      </dl><dl class="dl-horizontal">
        <dt>{% trans 'Flow type' %}</dt><dd>{{ initiative.flow_type }}</dd>
      </dl><dl class="dl-horizontal">
        <dt>{% trans 'Bi/Multilateral' %}</dt><dd>{{ initiative.bi_multi }}</dd>
      </dl>
      <ul class="list-unstyled simple-menu">
        {% if initiative.is_ftc %}<li>{% trans 'Free Standing Technical Cooperation' %}</li>{% endif %}
        {% if initiative.is_pba %}<li>{% trans 'Programme Based Approaches' %}</li>{% endif %}
        {% if initiative.is_investment %}<li>{% trans 'Investment Project' %}</li>{% endif %}
      </ul>

      {% with documents=initiative.documents %}{% if documents|length > 0 %}
      <h2>{% trans 'Documents' %}</h2>
      <ul class="list-unstyled simple-menu" style="height: auto;">
        {% for document in documents %}
          <li><a href="{% if document.file %}{{ document.file.url }}{% else %}{{ document.source_url|default:'#' }}{% endif %}">{% icon 'download' %} {{ document.name }}</a>
          <p class="small-paragraph">{{ document.description }}</p>
          <h5>{{ document.date|date:"r" }}</h5>
          </li>
        {% endfor %}
      </ul>
      {% endif %}{% endwith %}
    </div>

    <div class="col-md-8 col-sm-6 col-xs-6">
      <div class="spacer"></div>
      <div class="focus">
        {% with description=initiative.description %}{% if description %}
        <div class="project-description">
          <p class="readmore" data-max-height="90">
            {{ initiative.description|safe }}
            <a href="#" class="readmore-open">{% trans 'read more' %} {% icon 'caret-down' %}</a>
            <a href="#" class="readmore-close">{% trans 'close' %} {% icon 'caret-up' %}</a>
          </p>
        </div>
        {% endif %}{% endwith %}

      </div>

      {% with is_suspended=initiative.is_suspended status=initiative.status %}{% if is_suspended or status %}
      <div class="focus">
        {% if is_suspended %}
        <div class="pull-right">{% icon 'exclamation-circle' %} {% trans 'Suspended intervention' %}</div>{% endif %}
        <div>STATUS
          <div class="progress" style="width: 200px; display: inline-block; margin-bottom: 0; height: 14px; margin-top:4px; ">
            <div class="progress-bar" role="progressbar" aria-valuenow="{{ status }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ status }}%;">
              <span class="sr-only">{{ status }} {% trans 'Complete' %}</span>
            </div>
          </div>
          {{ initiative.status }}%
        </div>
      </div>
      {% endif %}{% endwith %}

      <div class="focus">
        <div class="row">
          <div class="col-md-4">
            <h4>{% trans 'Agency' %}</h4>{{ initiative.agency.name }}
          </div>
          <div class="col-md-4">
            <h4>{% trans 'Representative' %}</h4><small class="text-muted">{{ initiative.email|default:'-' }}</small>
          </div>
          <div class="col-md-4">
            <h4>{% trans 'Counterpart authority' %}</h4>{{ initiative.counterpart_authority|default:'-' }}
          </div>{% if initiative.other_financiers %}
          <div class="col-md-12">
            <h4>{% trans 'Other financiers' %}</h4>
            {{ initiative.other_financiers|default:'-' }}
          </div>{% endif %}
        </div>
      </div>

       {% with years=initiative.years_range %}{% if years %}
      <div class="focus">
        <h4>{% trans 'Start date' %}: {{ years|first }}{% if years|length > 1 %}
          {% trans 'End date' %}: {{ years|last }}{% endif %}</h4>
      </div>
      {% endif %}{% endwith %}

      {% if initiative.outcome %}
      <div class="focus">
        <h4>{% trans 'Main outcome' %}</h4>
        <p>{{ initiative.outcome|safe }}</p>
      </div>
      {% endif %}

      <div class="focus">

        <div class="row">
          <div class="col-md-6">
            {% with total_project_costs=initiative.total_project_costs loan_amount_approved=initiative.loan_amount_approved grant_amount_approved=initiative.grant_amount_approved %}{% if total_project_costs or loan_amount_approved or grant_amount_approved %}
              <h3>{% trans 'Total initiative costs' %}</h3>
              <div style="color:#f7505a; text-transform: uppercase;"><span style="font-size: 2.1em; font-weight: bold;">€ {{ total_project_costs|intcomma }}</span> suddivisi in</div>
              <div class="row">
                <div class="col-md-6">
                  <div class="list-group">
                    <p class="list-group-item" style="color:#2b6a7c; border-color:#2b6a7c; padding: 4px 8px;">
                      {% if initiative.loan_amount_approved %}
                      <strong>€ {{ initiative.loan_amount_approved|intcomma }}</strong>{% else %}-{% endif %}
                      <br/><span style="font-size: 0.8em">{% trans 'Loans' %}</span>
                    </p>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="list-group">
                    <p class="list-group-item" style="color:#2b6a7c; border-color:#2b6a7c; padding: 4px 8px;">
                      {% if initiative.grant_amount_approved %}
                      <strong>€ {{ initiative.grant_amount_approved|intcomma }}</strong>{% else %}-{% endif %}
                      <br/><span style="font-size: 0.8em">{% trans 'Grants' %}</span>
                    </p>
                  </div>
                </div>
              </div>
              {% endif %}{% endwith %}
          </div>
          <div class="col-md-6">
            <h3>{% trans 'Initiative projects' %}</h3>
            <ul class="list-unstyled simple-menu">
              {% for project in projects %}
              <li><a href="{{ project.get_absolute_url }}">{{ project.title }}</a></li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div><!-- .focus -->

      {% with beneficiaries=initiative.beneficiaries beneficiaries_female=initiative.beneficiaries_female %}{% if beneficiaries or beneficiaries_female %}
      <div class="focus">
        <h4>{% trans 'Beneficiaries' %}</h4>
        {% if beneficiaries %}<p>{{ beneficiaries }}</p>{% endif %}
        {% if beneficiaries_female %}<strong>
          {% blocktrans %}Beneficiaries of which females {{ beneficiaries_female }}%{% endblocktrans %}</strong>{% endif %}
      </div>{% endif %}{% endwith %}

      <div class="focus">
        <div class="row">
          <div class="col-md-5">
            <ul class="nav nav-pills" style="border: 0;">
                {% for sector in initiative.sectors|unique %}
                <li>
                    <a href="{% url 'codelists:sector-detail' code=sector.get_root.code %}">{% icon 'chevron-right' %}{{ sector.get_root.name }}</a>
                </li>
                {% endfor %}
            </ul>
          </div>
          <div class="col-md-4">
            <span class="eleven light-gray block">{% trans 'Aid type' %}</span>
                        {% for aid_type in initiative.aid_types|unique %}{% if aid_type %}
                        <a href="{% url 'codelists:aid_type-detail' code=aid_type.code %}" class="eleven">{{ aid_type.name }}</a>{% if not forloop.last %}, {% endif %}
                        {% endif %}{% endfor %}
          </div>
          <div class="col-md-3">
            <span class="eleven light-gray block">{% trans 'Channels' %}</span>
                        {% for channel in initiative.channels|unique %}{% if channel %}
                        <a href="{% url 'codelists:channel-detail' code=channel.code %}" class="eleven">{{ channel.name }}</a>{% if not forloop.last %}, {% endif %}
                        {% endif %}{% endfor %}
          </div>
        </div>
      </div>

      {% with problems=initiative.problems reports=initiative.reports %}{% if problems|length > 0 or reports|length > 0 %}
      <div class="row">
        {% if problems|length > 0 %}
        <div class="{% if reports|length > 0 %}col-md-6{% else %}col-md-12{% endif %}">
          <h3>{% trans "Problems" %}</h3>
          <ul class="list-unstyled simple-menu">
            {% for problem in initiative.problems %}
            <li>
              <h4>{{ problem.event }}</h4>
              <p>{{ problem.impact }}</p>
              {% if problem.actions %}
              <h4 class="light-gray">{% trans 'Actions taken' %}</h4>
              <strong>{{ problem.actions }}</strong>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        {% if reports|length > 0 %}
        <div class="{% if problems|length > 0 %}col-md-6{% else %}col-md-12{% endif %}">
          <h3>{% trans "Procurements" %}</h3>
          <ul class="list-unstyled simple-menu">
            {% for report in initiative.reports %}
            <li>
              <div class="pull-right"><span class="label" style="background-color: #2b6a7c;">{{ report.status }}</span></div>
              <h4>{{ report.awarding_entity }}</h4>
              <p>{{ report.description }}</p>

              <div class="row">
                <div class="col-md-6">
                  <h5 class="light-gray">{% trans 'Type' %}</h5>
                  <strong>{{ report.get_type_display }}</strong>
                </div>
                <div class="col-md-6">
                  <h5 class="light-gray">{% trans 'Procedure' %}</h5>
                  <strong>{{ report.get_procurement_procedure_display }}</strong>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    {% endif %}{% endwith %}


      {% with photo_set=initiative.photos %}{% if photo_set|length > 0 %}
        <h2>{% trans 'Photo gallery' %}</h2>
        <ul class="gallery">
          {% for photo in photo_set %}
            <li><img src="{{ photo.file.url }}"></li>
          {% endfor %}
        </ul>
      {% endif %}{% endwith %}

    </div>
  </div><!-- .row -->

{% endblock content %}